<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Lootara Pok√©mon Shop</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
</head>
<body class="bg-gray-100 text-gray-900">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Admin Panel</h1>

    <div class="flex flex-wrap gap-6">
      <form id="cardForm" class="bg-white p-6 rounded shadow-md w-full md:w-1/3">
        <input type="hidden" id="docId" />
        <div class="mb-4">
          <label class="block mb-1">Name</label>
          <input id="name" class="w-full border p-2" type="text" required />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Set</label>
          <input id="set" class="w-full border p-2" type="text" />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Condition</label>
          <input id="condition" class="w-full border p-2" type="text" placeholder="e.g., NM" />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Price</label>
          <input id="price" class="w-full border p-2" type="number" step="0.01" required />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Purchase Price</label>
          <input id="purchasePrice" class="w-full border p-2" type="number" step="0.01" />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Purchased From</label>
          <input id="purchasedFrom" class="w-full border p-2" type="text" />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Status</label>
          <select id="statusField" class="w-full border p-2">
            <option value="">Select Status</option>
            <option value="Inventory">Inventory</option>
            <option value="Listed">Listed</option>
            <option value="Pending Sale">Pending Sale</option>
            <option value="Sold">Sold</option>
            <option value="Archived">Archived</option>
          </select>
        </div>
        <div class="mb-4">
          <label class="block mb-1">Notes</label>
          <textarea id="notes" class="w-full border p-2" rows="3" placeholder="Additional details..."></textarea>
        </div>
        <div class="mb-4">
          <label class="block mb-1">Upload Images</label>
          <input id="imageUpload" class="w-full border p-2" type="file" accept="image/*" multiple />
        </div>
        <div class="mb-4">
          <label class="block mb-1">Stripe Checkout Link</label>
          <input id="stripeLink" class="w-full border p-2" type="url" />
        </div>
        <button class="bg-blue-600 text-white px-4 py-2 rounded" type="submit">Save Card</button>
      </form>

      <div class="flex-1 min-w-0">
        <div class="mb-4 flex flex-wrap gap-4">
          <input id="searchInput" class="border p-2 w-full sm:w-auto" type="text" placeholder="Search by name..." />
          <select id="filterStatus" class="border p-2">
            <option value="">All Statuses</option>
            <option value="Inventory">Inventory</option>
            <option value="Listed">Listed</option>
            <option value="Pending Sale">Pending Sale</option>
            <option value="Sold">Sold</option>
            <option value="Archived">Archived</option>
          </select>
        </div>
        <div id="status" class="text-sm text-green-600 mb-4"></div>
        <div id="cardList" class="space-y-4"></div>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCRxeeIUMQUQ1H8RIKk5lXh77IQAGHhMe4",
      authDomain: "lootara-website.firebaseapp.com",
      projectId: "lootara-website",
      storageBucket: "lootara-website.firebasestorage.app",
      messagingSenderId: "984923606768",
      appId: "1:984923606768:web:7d816b4c4dea60c6b7fc35",
      measurementId: "G-46CY0YCTW1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    const form = document.getElementById("cardForm");
    const status = document.getElementById("status");
    const cardList = document.getElementById("cardList");
    const searchInput = document.getElementById("searchInput");
    const filterStatus = document.getElementById("filterStatus");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const docId = form.docId.value;
      const files = document.getElementById("imageUpload").files;
      const imageUrls = [];

      try {
        if (files.length > 0) {
          for (const file of files) {
            const storageRef = storage.ref(`cards/${Date.now()}-${file.name}`);
            await storageRef.put(file);
            const url = await storageRef.getDownloadURL();
            imageUrls.push(url);
          }
        }

        const cardData = {
          name: form.name.value,
          set: form.set.value,
          condition: form.condition.value,
          price: parseFloat(form.price.value),
          purchasePrice: parseFloat(form.purchasePrice.value) || null,
          purchasedFrom: form.purchasedFrom.value,
          status: form.statusField.value,
          stripeLink: form.stripeLink.value || "",
          notes: form.notes.value || ""
        };

        if (imageUrls.length > 0) {
          cardData.images = imageUrls;
        }

        if (docId) {
          await db.collection("cards").doc(docId).update(cardData);
          status.textContent = "Card updated successfully!";
        } else {
          await db.collection("cards").add(cardData);
          status.textContent = "Card added successfully!";
        }

        form.reset();
        form.docId.value = "";
        loadCards();
      } catch (err) {
        status.textContent = "Error: " + err.message;
        status.classList.add("text-red-600");
      }
    });

    async function loadCards() {
      const snapshot = await db.collection("cards").get();
      cardList.innerHTML = "";
      const query = searchInput.value.toLowerCase();
      const statusFilter = filterStatus.value;

      snapshot.forEach(doc => {
        const card = doc.data();
        if (
          (!query || card.name.toLowerCase().includes(query)) &&
          (!statusFilter || card.status === statusFilter)
        ) {
          const div = document.createElement("div");
          div.className = "bg-white p-4 rounded shadow";
          div.innerHTML = `
            <h3 class="font-bold text-lg">${card.name}</h3>
            <p class="text-sm text-gray-600">Set: ${card.set || ''} | Condition: ${card.condition || ''}</p>
            <p class="text-sm">Price: $${card.price} | Purchase: $${card.purchasePrice || 0} | Status: ${card.status}</p>
            <p class="text-sm">Purchased From: ${card.purchasedFrom || ''}</p>
            <p class="text-sm">Notes: ${card.notes || ''}</p>
            <div class="flex flex-wrap gap-2 mt-2">
              ${(card.images || []).map(img => `<img src="${img}" class="w-20 h-20 object-cover rounded" />`).join('')}
            </div>
            <div class="mt-4 flex gap-2">
              <button class="bg-yellow-500 text-white px-3 py-1 rounded" onclick="editCard('${doc.id}')">Edit</button>
              <button class="bg-red-600 text-white px-3 py-1 rounded" onclick="deleteCard('${doc.id}')">Delete</button>
            </div>
          `;
          cardList.appendChild(div);
        }
      });
    }

    async function editCard(id) {
      const doc = await db.collection("cards").doc(id).get();
      if (doc.exists) {
        const card = doc.data();
        form.docId.value = id;
        form.name.value = card.name;
        form.set.value = card.set;
        form.condition.value = card.condition;
        form.price.value = card.price;
        form.purchasePrice.value = card.purchasePrice || "";
        form.purchasedFrom.value = card.purchasedFrom || "";
        form.statusField.value = card.status || "";
        form.stripeLink.value = card.stripeLink;
        form.notes.value = card.notes || "";
      }
    }

    async function deleteCard(id) {
      if (confirm("Are you sure you want to delete this card?")) {
        await db.collection("cards").doc(id).delete();
        loadCards();
      }
    }

    searchInput.addEventListener("input", loadCards);
    filterStatus.addEventListener("change", loadCards);

    loadCards();
  </script>
</body>
</html>
